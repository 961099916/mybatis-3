<?xml version="1.0" encoding="UTF-8" ?>
<!--

       Copyright 2009-2016 the original author or authors.

       Licensed under the Apache License, Version 2.0 (the "License");
       you may not use this file except in compliance with the License.
       You may obtain a copy of the License at

          http://www.apache.org/licenses/LICENSE-2.0

       Unless required by applicable law or agreed to in writing, software
       distributed under the License is distributed on an "AS IS" BASIS,
       WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
       See the License for the specific language governing permissions and
       limitations under the License.

-->
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.apache.ibatis.submitted.column_prefix.MapperNestedQuery">

    <resultMap id="petMapper"
               type="org.apache.ibatis.submitted.column_prefix.Pet">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <association property="room" select="selectRoom" column="room_id"/>
    </resultMap>

    <resultMap id="addressMapper"
               type="org.apache.ibatis.submitted.column_prefix.Address">
        <constructor>
            <idArg column="id" javaType="int"/>
            <arg column="state" javaType="string"/>
        </constructor>
        <result property="city" column="city"/>
        <result property="hasPhone" column="has_phone"/>
        <association property="stateBird" select="selectStateBird"
                     column="state"/>
        <association property="zip" select="selectZip"
                     column="{state=state,city=city}"/>
        <association property="phone1" select="selectPhone"
                     column="phone1_id"/>
        <association property="phone2" select="selectPhone"
                     column="phone2_id"/>
        <discriminator column="addr_type" javaType="int">
            <case value="1"
                  resultType="org.apache.ibatis.submitted.column_prefix.AddressWithCaution">
                <result property="caution" column="caution"/>
            </case>
        </discriminator>
    </resultMap>

    <resultMap id="personMapper"
               type="org.apache.ibatis.submitted.column_prefix.Person">
        <id property="id" column="person_id"/>
        <result property="name" column="person_name"/>
        <association property="room" select="selectRoom" column="person_room_id"/>
        <association property="billingAddress" resultMap="addressMapper"
                     notNullColumn="id" columnPrefix="b_"/>
        <association property="shippingAddress" resultMap="addressMapper"
                     notNullColumn="id" columnPrefix="s_"/>
        <collection property="pets" resultMap="petMapper"
                    columnPrefix="pet_"/>
    </resultMap>

    <select id="selectPets" resultMap="petMapper"><![CDATA[
        SELECT id,
               name,
               room_id
        FROM pet
        ORDER BY id
        ]]></select>

    <select id="selectPersons" resultMap="personMapper"><![CDATA[
        SELECT person.id                  AS person_id,
               person.name                AS person_name,
               person.room_id             AS person_room_id,
               billing_address.id         AS b_id,
               billing_address.state      AS b_state,
               billing_address.city       AS b_city,
               billing_address.phone1_id  AS b_phone1_id,
               billing_address.phone2_id  AS b_phone2_id,
               billing_address.addr_type  AS b_addr_type,
               billing_address.caution    AS b_caution,
               CASE
                   WHEN billing_address.phone1_id IS NULL
                       AND billing_address.phone2_id IS NULL
                       THEN FALSE
                   ELSE TRUE
                   END                    AS b_has_phone,
               shipping_address.id        AS s_id,
               shipping_address.state     AS s_state,
               shipping_address.city      AS s_city,
               shipping_address.phone1_id AS s_phone1_id,
               shipping_address.phone2_id AS s_phone2_id,
               shipping_address.addr_type AS s_addr_type,
               shipping_address.caution   AS s_caution,
               CASE
                   WHEN shipping_address.phone1_id IS NULL
                       AND shipping_address.phone2_id IS NULL
                       THEN FALSE
                   ELSE TRUE
                   END                    AS s_has_phone,
               pet.id                     AS pet_id,
               pet.name                   AS pet_name,
               pet.room_id                AS pet_room_id
        FROM person
                 LEFT JOIN address billing_address
                           ON billing_address.id = person.billing_address_id
                 LEFT JOIN address shipping_address
                           ON shipping_address.id = person.shipping_address_id
                 LEFT JOIN pet ON pet.owner_id = person.id
        ORDER BY person.id, pet.id
        ]]></select>

    <select id="selectPhone" parameterType="int"
            resultType="org.apache.ibatis.submitted.column_prefix.Phone"><![CDATA[
        SELECT id,
               phone,
               area_code
        FROM phone
        WHERE id = #{id}
        ]]></select>

    <select id="selectRoom" resultType="org.apache.ibatis.submitted.column_prefix.Room"
            parameterType="int"><![CDATA[
        SELECT room_id,
               room_name
        FROM room
        WHERE room_id = #{id}
        ]]></select>

    <select id="selectZip" resultType="org.apache.ibatis.submitted.column_prefix.Zip"
            parameterType="org.apache.ibatis.submitted.column_prefix.Zip"><![CDATA[
        SELECT state,
               city,
               zip_code
        FROM zip
        WHERE state = #{state}
          AND city = #{city}
        ]]></select>

    <select id="selectStateBird" resultType="string" parameterType="string"><![CDATA[
        SELECT bird
        FROM state_bird
        WHERE state = #{state}
        ]]></select>

</mapper>
